<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>모각코 모두 보기</title>
</head>
<body>

<h1> 모각코 모두 찾아보기 </h1>

<div class="meetings"></div>

<script th:inline="javascript">

    window.onload = () => {
        var httpRequest = getHttpInstance();

        const meetingsDiv = document.querySelector(".meetings")


        fetch('/api/meeting')
            .then(response => response.json())
            .then(meetings => {

                meetings.forEach(meeting => {
                    const body = `
                        <div style="margin: 10px 0px 10px 10px" name="meeting">
                            <div name="meetingInfo" value="${meeting.meetingId}">
                                ${makeBody("모임 이름", meeting.name)}
                                ${makeBody("주소", meeting.primaryAddress)}
                                ${makeBody("장소명",  meeting.placeName)}
                                ${makeBody("날짜", meeting.startAt, "~", meeting.endAt)}
                            </div>
                            <button type="button" name='participate'> 참가하기 </button>
                        </div>
                     `

                    meetingsDiv.innerHTML += body
                })

                const participateButton = document.querySelectorAll('button[name="participate"]');

                participateButton.forEach( button => {
                    const meetingId = button.closest('div[name="meeting"]')
                        .querySelector('div[name="meetingInfo"]')
                        .getAttribute(`value`)

                    button.addEventListener("click", () => participate(meetingId))
                })

                const meetingElements = document.querySelectorAll('div[name="meetingInfo"]');

                meetingElements
                    .forEach(element => element.addEventListener(
                        "click",
                        () => {
                            const meetingId = element.getAttribute("value")
                            location.href = `/meeting-detail/${meetingId}`
                        })
                    )
            })
            .catch(error => {
                console.error(error)
                alert(error)
            });

        // Function
        const makeBody = (text, ...data) => `<div> ${text} : ${data.join(" ")} </div>`

        const participate = meetingId => {
            const participateMeetingRequestDto = {
                "meetingId" : meetingId,
                "memberId": 1,
            }

            callRestApi(() => participateEvent(meetingId), "POST", "/api/meeting/participate", participateMeetingRequestDto)
        }

        function getHttpInstance() {
            if(!httpRequest) {
                httpRequest = new XMLHttpRequest();
            }

            return httpRequest;
        }

        function callRestApi(e, type, url, data) {
            const jsonParsedData = data ? JSON.stringify(data) : null;

            httpRequest.onreadystatechange = e;
            httpRequest.open(type, url);
            httpRequest.setRequestHeader("Content-Type", "application/json")
            httpRequest.send(jsonParsedData);
        }

        function participateEvent(meetingId) {
            try {
                if (httpRequest.readyState === XMLHttpRequest.DONE) {
                    if (httpRequest.status === 200) {
                        alert("모임 참가에 성공했습니다.")
                        window.location.href = `/meeting-detail/${meetingId}`
                    } else {
                        alert("모임 참가에 실패했습니다.");
                        return;
                     }
                }
            }
            catch( e ) {
                alert(`요청에 실패했습니다. 서버에 문의해주세요.`);
            }
        }
    }

</script>

</body>
</html>